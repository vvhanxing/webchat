<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>智能对练Agent</title>
    <link rel="stylesheet" href="./static/reset-2.0.min.css">
    <link rel="stylesheet" href="./static/style.css">
    <script src="./static/echarts.min.js"></script>


</head>

<body>
    <!-- partial:index.partial.html -->
    <div class="container">


        <div class="screen screen-2 raised">
            <div class="top">
                <div class="bubbles">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>

            </div>
            <div class="bottom">
                <div class="nav">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot active"></div>
                </div>
                <h1 class="title">产品售后与用户对话场景演练</h1>
                <p>模拟用户现场对话场景</p>
                <div class="call-to-action">
                    <button class="clay">开始对练</button>
                </div>
            </div>

        </div>



        <!-- ========== 新增 screen-4  ============ -->
        <div class="screen screen-4 raised">

            <!-- 视频标题 -->
            <div class="video-title">🚩改进型辅导的思路与...</div>
            <!-- 里程碑 -->
            <div class="milestone">里程碑: 0/7</div>

            <span class="material-icons close-btn">close</span>
            <!-- 动态人物动画区域 -->
            <div class="character-animation" id="character-animation">
                <video id="animation-video" loop muted playsinline></video>
            </div>
            <!-- 对话内容容器 -->
            <div class="chat-container">
                <!-- <div class="chat-message assistant">
                    <p>吗？还是说最近的工作压力大呢？</p>
                </div>
                <div class="chat-message user">
                    <p>也没啥，工作也还是跟往常一样的，领导您放心吧。我这最近确实忙，得照顾家里，还得工作，压力是有点大，但我能克服，我工作还是挺认真的，我觉着没啥问题啊。</p>
                </div> -->
                <div id="chat-messages"></div>
            </div>
            <!-- 录音按钮区域 -->
            <div class="record-area">
                <button id="record-btn">点击说话</button>
            </div>

            <audio id="tts-audio" controls autoplay style="display: none;"></audio>

        </div>


        <div class="screen screen-1 raised">
            <div class="cs-name">
                <span>培训分析报告</span>
                <span class="material-icons bell">notifications</span>
            </div>

            <!-- 搜索框保留 -->
            <div class="cs-search">
                <input type="search" placeholder="搜索...">
                <span class="material-icons search-icon">search</span>
            </div>

            <!-- 雷达图容器 -->
            <div class="report-section">
                <div class="cs-name">
                    <span>能力雷达图</span>
                </div>
                <div id="radarChart" style="width: 240%; height: 260px;"></div>
            </div>

            <!-- 改进计划 -->
            <div class="improvement-plan cs-activities">
                <div class="cs-name">
                    <span>改进计划</span>
                </div>
                <menu class="activities-list">
                    <li class="item-category work">
                        <span class="material-icons">edit</span>
                        <span class="text">提升沟通技巧</span>
                    </li>
                    <li class="item-category leisure not-active">
                        <span class="material-icons-outlined">timer</span>
                        <span class="text">优化时间管理</span>
                    </li>
                    <li class="item-category education not-active">
                        <span class="material-icons-outlined">people</span>
                        <span class="text">加强团队协作意识</span>
                    </li>
                </menu>
            </div>

            <!-- 用户反馈引导 -->
            <div class="feedback-guide cs-activities">
                <div class="cs-name">
                    <span>反馈建议</span>
                </div>
                <p style="font-size: 0.7rem; color: #888; padding: 0.5rem;">
                    如果您有其他想补充的反馈，请点击下方按钮提交。
                </p>
                <button class="clay flatter flex-center" style="width: 100%;">提交反馈</button>
            </div>

            <!-- 底部导航栏保持不变 -->
            <div class="cs-footer">
                <span class="material-icons btn-home">home</span>
                <span class="material-icons btn-cart">calendar_month</span>
                <!-- <span class="material-icons btn-add clay">add</span> -->
            </div>
        </div>



        <!-- ========== JS 脚本部分 ============ -->
        <script>
            // 获取DOM元素
            const recordBtn = document.getElementById('record-btn');
            const characterAnimation = document.getElementById('character-animation');

            // 设置动画状态常量
            const ANIMATION_STATE = {
                TALKING: 'talking',
                IDLE: 'idle'
            };



            // 按钮按下事件
            recordBtn.addEventListener('mousedown', () => {
                updateAnimation(ANIMATION_STATE.IDLE);
            });

            // 按钮松开事件
            recordBtn.addEventListener('mouseup', () => {
                updateAnimation(ANIMATION_STATE.TALKING);
            });



            // 触摸设备支持
            recordBtn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 防止触摸事件和鼠标事件冲突
                updateAnimation(ANIMATION_STATE.IDLE);
            });

            recordBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                updateAnimation(ANIMATION_STATE.TALKING);
            });
        </script>

        <script>
            // 初始化雷达图
            const chartDom = document.getElementById('radarChart');
            const myChart = echarts.init(chartDom);

            const option = {
                tooltip: {},
                radar: {
                    indicator: [
                        { name: '沟通能力', max: 10 },
                        { name: '应变能力', max: 10 },
                        { name: '产品知识', max: 10 },
                        { name: '服务意识', max: 10 },
                        { name: '情绪控制', max: 10 }
                    ],
                    shape: 'circle',
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(31, 168, 245, 0.2)'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(31, 168, 245, 0.5)'
                        }
                    },
                    splitArea: {
                        show: false
                    }
                },
                series: [{
                    name: '评分',
                    type: 'radar',
                    data: [{
                        value: [7, 8, 9, 6, 7],
                        name: '能力评分'
                    }],
                    areaStyle: {
                        color: 'rgba(31, 168, 245, 0.3)'
                    },
                    itemStyle: {
                        color: '#1fa8f5'
                    }
                }]
            };

            myChart.setOption(option);
        </script>

        <script>
            let hasPreloaded = false;

            function showScreen(screenClass) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                const target = document.querySelector(`.${screenClass}`);
                if (target) {
                    target.classList.add('active');
                }

                // 如果切换到 screen-4，初始化 idle 动画
                if (screenClass === 'screen-4') {




                    updateAnimation(ANIMATION_STATE.IDLE);
                }
            }


            // 初始显示 screen-2
            showScreen('screen-2');

            // 绑定按钮点击事件
            document.querySelector('.screen-2 .clay')?.addEventListener('click', () => {
                showScreen('screen-4');
            });

            document.querySelector('.close-btn')?.addEventListener('click', () => {
                showScreen('screen-1');
            });

            document.querySelector('.btn-home')?.addEventListener('click', () => {
                showScreen('screen-2');
            });
        </script>


        <script>
            const audioPlayer = document.getElementById("tts-audio");
            let mediaSource = null;
            let sourceBuffer = null;
            let buffer = [];

            function appendBuffer() {
                if (sourceBuffer && !sourceBuffer.updating && buffer.length > 0) {
                    const chunk = buffer.shift();
                    sourceBuffer.appendBuffer(chunk);
                } else if (buffer.length > 0) {
                    setTimeout(appendBuffer, 100);
                }
            }

            async function playTextToSpeech(text) {
                if (!text) return;

                // 重置播放器
                if (mediaSource) {
                    mediaSource.endOfStream();
                    mediaSource = null;
                    sourceBuffer = null;
                    buffer = [];
                }

                mediaSource = new MediaSource();
                audioPlayer.src = URL.createObjectURL(mediaSource);
                audioPlayer.style.display = "block";

                // 在 ended/error 中清除
                audioPlayer.addEventListener('ended', () => {

                    updateAnimation(ANIMATION_STATE.IDLE);
                }, { once: true });

                audioPlayer.addEventListener('error', () => {

                    updateAnimation(ANIMATION_STATE.IDLE);
                }, { once: true });


                mediaSource.addEventListener('sourceopen', () => {
                    sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');
                    sourceBuffer.mode = 'sequence';
                });

                const ws = new WebSocket('wss://10.199.164.14:5001/tts');
                ws.binaryType = 'blob';

                ws.onopen = () => {
                    console.log('TTS WebSocket connected');
                    ws.send("TEXT:" + text);
                };

                ws.onmessage = function (event) {
                    if (typeof event.data === 'string' && event.data.startsWith("ERROR:")) {
                        console.error(event.data);
                        return;
                    }

                    if (event.data instanceof Blob) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            const arrayBuffer = reader.result;
                            buffer.push(new Uint8Array(arrayBuffer));
                            appendBuffer();
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };

                ws.onclose = () => {

                    console.log('TTS WebSocket closed');


                };

                ws.onerror = (err) => {
                    console.log("TTS WebSocket 错误:", err);
                };
            }
        </script>



        <script>

            const chatBox = document.getElementById('chat-messages');

            let ws = null;
            let audioContext = null;
            let mediaStream = null;
            let mediaStreamSource = null;
            let scriptProcessor = null;
            let partialText = "";
            let currentText = "";



            // 预加载视频对象
            const videoSources = {
                idle: './static/idle2.mp4',
                talking: './static/talking2.mp4'
            };

            // 缓存预加载的视频元素
            const cachedVideos = {};

            // 预加载视频
            function preloadVideo(key, src) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.src = src;
                    video.muted = true;
                    video.loop = true;
                    video.preload = 'auto';

                    video.onloadeddata = () => {
                        // 视频元数据加载完成，可以播放第一帧
                        cachedVideos[key] = video;
                        resolve(video);
                    };

                    video.onerror = (err) => {
                        console.error(`预加载视频失败: ${key}`, err);
                        reject(err);
                    };

                    // 手动加载
                    video.load();
                });
            }



            // 更新动画（使用缓存或动态创建）

            function updateAnimation(state) {
                const video = document.getElementById('animation-video');

                if (!video) return;

                const targetKey = state === ANIMATION_STATE.IDLE ? 'idle' : 'talking';
                const targetSrc = videoSources[targetKey];

                if (state === ANIMATION_STATE.IDLE && hasPreloaded === true) {

                    recordBtn.classList.add('recording');
                    recordBtn.textContent = '正在聆听...';

                } else {

                    recordBtn.classList.remove('recording');
                    recordBtn.textContent = '点击说话';
                }

                hasPreloaded = true;

                // 如果已有缓存视频，直接使用
                if (cachedVideos[targetKey]) {
                    const cachedVideo = cachedVideos[targetKey];
                    if (video.src !== cachedVideo.src) {
                        video.src = cachedVideo.src;
                        video.muted = true;
                        video.loop = true;
                    }
                    video.play().catch(err => {
                        console.warn("播放被阻止", err);
                    });
                    return;
                }

                // 降级：直接设置 src
                if (video.src !== targetSrc) {
                    video.src = targetSrc;
                }
                video.muted = true;
                video.loop = true;
                video.play().catch(err => {
                    console.warn("自动播放被阻止", err);
                });
            }



            async function startRecording() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
                    scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                    mediaStreamSource.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    // 建立 WebSocket
                    ws = new WebSocket('wss://10.199.164.14:5001/record');

                    ws.onopen = () => {
                        console.log("Record WebSocket 已连接");
                    };

                    ws.onmessage = function (event) {
                        const data = JSON.parse(event.data);

                        //partial
                        if (data.type === 'partial') {
                            partialText = data.text;
                            updateChatMessage(partialText);
                        }


                        if (data.type === 'final') {
                            partialText = "";
                            currentText += data.text;
                            updateChatMessage(currentText);
                        }
                    };

                    ws.onerror = function (err) {
                        console.error("Record WebSocket 错误:", err);
                    };

                    ws.onclose = function () {
                        console.log("Record WebSocket 已关闭");
                    };

                    scriptProcessor.onaudioprocess = function (e) {
                        const inputBuffer = e.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        const buffer = new ArrayBuffer(inputData.length * 2);
                        const view = new DataView(buffer);
                        let index = 0;
                        for (let i = 0; i < inputData.length; i++) {
                            const s = Math.max(-1, Math.min(1, inputData[i]));
                            const val = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            view.setInt16(index, val, true);
                            index += 2;
                        }
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(buffer);
                        }
                    };

                    updateAnimation(ANIMATION_STATE.IDLE);
                } catch (err) {
                    console.error('无法获取麦克风权限', err);
                    alert('请允许麦克风权限');
                }
            }

            function stopRecording() {
                console.log(">停止录音");
                if (scriptProcessor) {
                    scriptProcessor.disconnect();
                    scriptProcessor.onaudioprocess = null;
                    scriptProcessor = null;
                }
                if (mediaStreamSource) {
                    mediaStreamSource.disconnect();
                    mediaStreamSource = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                if (ws) {
                    ws.close();
                    ws = null;
                }


                if (currentText) {
                    sendMessageToChat(currentText);
                    currentText = "";
                }

                updateAnimation(ANIMATION_STATE.TALKING);
            }

            function updateChatMessage(text) {
                const last = chatBox.lastChild;
                if (last && chatBox.querySelector('.chat-message.user').querySelector('p')) {
                    // last.querySelector('p').textContent = text;

                    chatBox.querySelector('.chat-message.user').querySelector('p').textContent = text;

                    if (chatBox.querySelector('.chat-message.assistant')) {
                        chatBox.querySelector('.chat-message.assistant').querySelector('p').textContent = "";
                    }

                } else {
                    const div = document.createElement('div');
                    div.className = 'chat-message user';
                    div.innerHTML = `<p>${text}</p>`;
                    chatBox.appendChild(div);
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function appendAssistantMessage(text) {
                const div = document.createElement('div');
                div.className = 'chat-message assistant';
                div.innerHTML = `<p>${text}</p>`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            let currentConversationId = ""; // 保存当前会话 ID
            let currentUser = "user-001";   // 假设前端指定用户 ID


            async function sendMessageToChat(text) {
                console.log("发送用户输入：", text);
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text,
                        user_id: currentUser,
                        conversation_id: currentConversationId
                    })
                });

                if (!response.ok) {
                    appendAssistantMessage("抱歉，服务器出错了。");
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    console.log("接收到的数据：", chunk);

                    // ===== 修复关键：处理包含结束标记的chunk =====
                    const endIndex = chunk.indexOf("【对话结束】");
                    if (endIndex !== -1) {
                        // 1. 提取结束标记前的有效文本
                        const validText = chunk.substring(0, endIndex);
                        assistantText += validText;

                        // 2. 立即更新UI（修复点：确保有效文本被显示）
                        if (chatBox.lastChild && chatBox.lastChild.classList.contains('assistant')) {
                            chatBox.lastChild.querySelector('p').textContent = assistantText;
                        } else if (validText.trim()) { // 避免创建空消息
                            appendAssistantMessage(assistantText);
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;

                        // 3. 处理结束标记（提取conversation_id）
                        const match = chunk.match(/Conversation ID: ([a-f0-9\-]+)/);
                        if (match) {
                            currentConversationId = match[1];
                            console.log("更新 conversation_id 为：", currentConversationId);
                        }
                        // 注意：结束标记后的部分（如ID信息）不添加到消息
                    }
                    // ===== 修复结束 =====
                    else {
                        assistantText += chunk;
                        if (chatBox.lastChild && chatBox.lastChild.classList.contains('assistant')) {
                            chatBox.lastChild.querySelector('p').textContent = assistantText;
                        } else {
                            appendAssistantMessage(assistantText);
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }

                if (assistantText.trim()) {
                    playTextToSpeech(assistantText);
                }

                if (assistantText.trim()) {
                    playTextToSpeech(assistantText); // 调用 TTS 播放语音

                }
            }





            // 绑定按钮事件
            recordBtn.addEventListener('mousedown', startRecording);
            recordBtn.addEventListener('mouseup', stopRecording);


            recordBtn.addEventListener('touchstart', e => {
                e.preventDefault();
                startRecording();
            });
            recordBtn.addEventListener('touchend', e => {
                e.preventDefault();
                stopRecording();
            });

            // 初始化预加载
            async function initAnimationSystem() {
                try {
                    await Promise.all([
                        preloadVideo('idle', videoSources.idle),
                        preloadVideo('talking', videoSources.talking)
                    ]);
                    console.log('✅ 视频预加载完成');
                } catch (err) {
                    console.warn('⚠️ 视频预加载失败，降级处理', err);
                }
            }


            // 页面加载完成后预加载动画视频
            window.addEventListener('load', () => {
                initAnimationSystem();
            });

        </script>



</body>

</html>
