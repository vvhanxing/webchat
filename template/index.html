<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å¯¹ç»ƒAgent</title>
    <link rel="stylesheet" href="./static/reset-2.0.min.css">
    <link rel="stylesheet" href="./static/style.css">
    <script src="./static/echarts.min.js"></script>


</head>

<body>
    <!-- partial:index.partial.html -->
    <div class="container">


        <div class="screen screen-2 raised">
            <div class="top">
                <div class="bubbles">
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                    <div class="bubble"></div>
                </div>

            </div>
            <div class="bottom">
                <div class="nav">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot active"></div>
                </div>
                <h1 class="title">äº§å“å”®åä¸ç”¨æˆ·å¯¹è¯åœºæ™¯æ¼”ç»ƒ</h1>
                <p>æ¨¡æ‹Ÿç”¨æˆ·ç°åœºå¯¹è¯åœºæ™¯</p>
                <div class="call-to-action">
                    <button class="clay">å¼€å§‹å¯¹ç»ƒ</button>
                </div>
            </div>

        </div>



        <!-- ========== æ–°å¢ screen-4  ============ -->
        <div class="screen screen-4 raised">

            <!-- è§†é¢‘æ ‡é¢˜ -->
            <div class="video-title">ğŸš©æ”¹è¿›å‹è¾…å¯¼çš„æ€è·¯ä¸...</div>
            <!-- é‡Œç¨‹ç¢‘ -->
            <div class="milestone">é‡Œç¨‹ç¢‘: 0/7</div>

            <span class="material-icons close-btn">close</span>
            <!-- åŠ¨æ€äººç‰©åŠ¨ç”»åŒºåŸŸ -->
            <div class="character-animation" id="character-animation">
                <video id="animation-video" loop muted playsinline></video>
            </div>
            <!-- å¯¹è¯å†…å®¹å®¹å™¨ -->
            <div class="chat-container">
                <!-- <div class="chat-message assistant">
                    <p>å—ï¼Ÿè¿˜æ˜¯è¯´æœ€è¿‘çš„å·¥ä½œå‹åŠ›å¤§å‘¢ï¼Ÿ</p>
                </div>
                <div class="chat-message user">
                    <p>ä¹Ÿæ²¡å•¥ï¼Œå·¥ä½œä¹Ÿè¿˜æ˜¯è·Ÿå¾€å¸¸ä¸€æ ·çš„ï¼Œé¢†å¯¼æ‚¨æ”¾å¿ƒå§ã€‚æˆ‘è¿™æœ€è¿‘ç¡®å®å¿™ï¼Œå¾—ç…§é¡¾å®¶é‡Œï¼Œè¿˜å¾—å·¥ä½œï¼Œå‹åŠ›æ˜¯æœ‰ç‚¹å¤§ï¼Œä½†æˆ‘èƒ½å…‹æœï¼Œæˆ‘å·¥ä½œè¿˜æ˜¯æŒºè®¤çœŸçš„ï¼Œæˆ‘è§‰ç€æ²¡å•¥é—®é¢˜å•Šã€‚</p>
                </div> -->
                <div id="chat-messages"></div>
            </div>
            <!-- å½•éŸ³æŒ‰é’®åŒºåŸŸ -->
            <div class="record-area">
                <button id="record-btn">ç‚¹å‡»è¯´è¯</button>
            </div>

            <audio id="tts-audio" controls autoplay style="display: none;"></audio>

        </div>


        <div class="screen screen-1 raised">
            <div class="cs-name">
                <span>åŸ¹è®­åˆ†ææŠ¥å‘Š</span>
                <span class="material-icons bell">notifications</span>
            </div>

            <!-- æœç´¢æ¡†ä¿ç•™ -->
            <div class="cs-search">
                <input type="search" placeholder="æœç´¢...">
                <span class="material-icons search-icon">search</span>
            </div>

            <!-- é›·è¾¾å›¾å®¹å™¨ -->
            <div class="report-section">
                <div class="cs-name">
                    <span>èƒ½åŠ›é›·è¾¾å›¾</span>
                </div>
                <div id="radarChart" style="width: 240%; height: 260px;"></div>
            </div>

            <!-- æ”¹è¿›è®¡åˆ’ -->
            <div class="improvement-plan cs-activities">
                <div class="cs-name">
                    <span>æ”¹è¿›è®¡åˆ’</span>
                </div>
                <menu class="activities-list">
                    <li class="item-category work">
                        <span class="material-icons">edit</span>
                        <span class="text">æå‡æ²Ÿé€šæŠ€å·§</span>
                    </li>
                    <li class="item-category leisure not-active">
                        <span class="material-icons-outlined">timer</span>
                        <span class="text">ä¼˜åŒ–æ—¶é—´ç®¡ç†</span>
                    </li>
                    <li class="item-category education not-active">
                        <span class="material-icons-outlined">people</span>
                        <span class="text">åŠ å¼ºå›¢é˜Ÿåä½œæ„è¯†</span>
                    </li>
                </menu>
            </div>

            <!-- ç”¨æˆ·åé¦ˆå¼•å¯¼ -->
            <div class="feedback-guide cs-activities">
                <div class="cs-name">
                    <span>åé¦ˆå»ºè®®</span>
                </div>
                <p style="font-size: 0.7rem; color: #888; padding: 0.5rem;">
                    å¦‚æœæ‚¨æœ‰å…¶ä»–æƒ³è¡¥å……çš„åé¦ˆï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æäº¤ã€‚
                </p>
                <button class="clay flatter flex-center" style="width: 100%;">æäº¤åé¦ˆ</button>
            </div>

            <!-- åº•éƒ¨å¯¼èˆªæ ä¿æŒä¸å˜ -->
            <div class="cs-footer">
                <span class="material-icons btn-home">home</span>
                <span class="material-icons btn-cart">calendar_month</span>
                <!-- <span class="material-icons btn-add clay">add</span> -->
            </div>
        </div>



        <!-- ========== JS è„šæœ¬éƒ¨åˆ† ============ -->
        <script>
            // è·å–DOMå…ƒç´ 
            const recordBtn = document.getElementById('record-btn');
            const characterAnimation = document.getElementById('character-animation');

            // è®¾ç½®åŠ¨ç”»çŠ¶æ€å¸¸é‡
            const ANIMATION_STATE = {
                TALKING: 'talking',
                IDLE: 'idle'
            };



            // æŒ‰é’®æŒ‰ä¸‹äº‹ä»¶
            recordBtn.addEventListener('mousedown', () => {
                updateAnimation(ANIMATION_STATE.IDLE);
            });

            // æŒ‰é’®æ¾å¼€äº‹ä»¶
            recordBtn.addEventListener('mouseup', () => {
                updateAnimation(ANIMATION_STATE.TALKING);
            });



            // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
            recordBtn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // é˜²æ­¢è§¦æ‘¸äº‹ä»¶å’Œé¼ æ ‡äº‹ä»¶å†²çª
                updateAnimation(ANIMATION_STATE.IDLE);
            });

            recordBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                updateAnimation(ANIMATION_STATE.TALKING);
            });
        </script>

        <script>
            // åˆå§‹åŒ–é›·è¾¾å›¾
            const chartDom = document.getElementById('radarChart');
            const myChart = echarts.init(chartDom);

            const option = {
                tooltip: {},
                radar: {
                    indicator: [
                        { name: 'æ²Ÿé€šèƒ½åŠ›', max: 10 },
                        { name: 'åº”å˜èƒ½åŠ›', max: 10 },
                        { name: 'äº§å“çŸ¥è¯†', max: 10 },
                        { name: 'æœåŠ¡æ„è¯†', max: 10 },
                        { name: 'æƒ…ç»ªæ§åˆ¶', max: 10 }
                    ],
                    shape: 'circle',
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(31, 168, 245, 0.2)'
                        }
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(31, 168, 245, 0.5)'
                        }
                    },
                    splitArea: {
                        show: false
                    }
                },
                series: [{
                    name: 'è¯„åˆ†',
                    type: 'radar',
                    data: [{
                        value: [7, 8, 9, 6, 7],
                        name: 'èƒ½åŠ›è¯„åˆ†'
                    }],
                    areaStyle: {
                        color: 'rgba(31, 168, 245, 0.3)'
                    },
                    itemStyle: {
                        color: '#1fa8f5'
                    }
                }]
            };

            myChart.setOption(option);
        </script>

        <script>
            let hasPreloaded = false;

            function showScreen(screenClass) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                const target = document.querySelector(`.${screenClass}`);
                if (target) {
                    target.classList.add('active');
                }

                // å¦‚æœåˆ‡æ¢åˆ° screen-4ï¼Œåˆå§‹åŒ– idle åŠ¨ç”»
                if (screenClass === 'screen-4') {




                    updateAnimation(ANIMATION_STATE.IDLE);
                }
            }


            // åˆå§‹æ˜¾ç¤º screen-2
            showScreen('screen-2');

            // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelector('.screen-2 .clay')?.addEventListener('click', () => {
                showScreen('screen-4');
            });

            document.querySelector('.close-btn')?.addEventListener('click', () => {
                showScreen('screen-1');
            });

            document.querySelector('.btn-home')?.addEventListener('click', () => {
                showScreen('screen-2');
            });
        </script>


        <script>
            const audioPlayer = document.getElementById("tts-audio");
            let mediaSource = null;
            let sourceBuffer = null;
            let buffer = [];

            function appendBuffer() {
                if (sourceBuffer && !sourceBuffer.updating && buffer.length > 0) {
                    const chunk = buffer.shift();
                    sourceBuffer.appendBuffer(chunk);
                } else if (buffer.length > 0) {
                    setTimeout(appendBuffer, 100);
                }
            }

            async function playTextToSpeech(text) {
                if (!text) return;

                // é‡ç½®æ’­æ”¾å™¨
                if (mediaSource) {
                    mediaSource.endOfStream();
                    mediaSource = null;
                    sourceBuffer = null;
                    buffer = [];
                }

                mediaSource = new MediaSource();
                audioPlayer.src = URL.createObjectURL(mediaSource);
                audioPlayer.style.display = "block";

                // åœ¨ ended/error ä¸­æ¸…é™¤
                audioPlayer.addEventListener('ended', () => {

                    updateAnimation(ANIMATION_STATE.IDLE);
                }, { once: true });

                audioPlayer.addEventListener('error', () => {

                    updateAnimation(ANIMATION_STATE.IDLE);
                }, { once: true });


                mediaSource.addEventListener('sourceopen', () => {
                    sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');
                    sourceBuffer.mode = 'sequence';
                });

                const ws = new WebSocket('wss://10.199.164.14:5001/tts');
                ws.binaryType = 'blob';

                ws.onopen = () => {
                    console.log('TTS WebSocket connected');
                    ws.send("TEXT:" + text);
                };

                ws.onmessage = function (event) {
                    if (typeof event.data === 'string' && event.data.startsWith("ERROR:")) {
                        console.error(event.data);
                        return;
                    }

                    if (event.data instanceof Blob) {
                        const reader = new FileReader();
                        reader.onload = function () {
                            const arrayBuffer = reader.result;
                            buffer.push(new Uint8Array(arrayBuffer));
                            appendBuffer();
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };

                ws.onclose = () => {

                    console.log('TTS WebSocket closed');


                };

                ws.onerror = (err) => {
                    console.log("TTS WebSocket é”™è¯¯:", err);
                };
            }
        </script>



        <script>

            const chatBox = document.getElementById('chat-messages');

            let ws = null;
            let audioContext = null;
            let mediaStream = null;
            let mediaStreamSource = null;
            let scriptProcessor = null;
            let partialText = "";
            let currentText = "";



            // é¢„åŠ è½½è§†é¢‘å¯¹è±¡
            const videoSources = {
                idle: './static/idle2.mp4',
                talking: './static/talking2.mp4'
            };

            // ç¼“å­˜é¢„åŠ è½½çš„è§†é¢‘å…ƒç´ 
            const cachedVideos = {};

            // é¢„åŠ è½½è§†é¢‘
            function preloadVideo(key, src) {
                return new Promise((resolve, reject) => {
                    const video = document.createElement('video');
                    video.src = src;
                    video.muted = true;
                    video.loop = true;
                    video.preload = 'auto';

                    video.onloadeddata = () => {
                        // è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œå¯ä»¥æ’­æ”¾ç¬¬ä¸€å¸§
                        cachedVideos[key] = video;
                        resolve(video);
                    };

                    video.onerror = (err) => {
                        console.error(`é¢„åŠ è½½è§†é¢‘å¤±è´¥: ${key}`, err);
                        reject(err);
                    };

                    // æ‰‹åŠ¨åŠ è½½
                    video.load();
                });
            }



            // æ›´æ–°åŠ¨ç”»ï¼ˆä½¿ç”¨ç¼“å­˜æˆ–åŠ¨æ€åˆ›å»ºï¼‰

            function updateAnimation(state) {
                const video = document.getElementById('animation-video');

                if (!video) return;

                const targetKey = state === ANIMATION_STATE.IDLE ? 'idle' : 'talking';
                const targetSrc = videoSources[targetKey];

                if (state === ANIMATION_STATE.IDLE && hasPreloaded === true) {

                    recordBtn.classList.add('recording');
                    recordBtn.textContent = 'æ­£åœ¨è†å¬...';

                } else {

                    recordBtn.classList.remove('recording');
                    recordBtn.textContent = 'ç‚¹å‡»è¯´è¯';
                }

                hasPreloaded = true;

                // å¦‚æœå·²æœ‰ç¼“å­˜è§†é¢‘ï¼Œç›´æ¥ä½¿ç”¨
                if (cachedVideos[targetKey]) {
                    const cachedVideo = cachedVideos[targetKey];
                    if (video.src !== cachedVideo.src) {
                        video.src = cachedVideo.src;
                        video.muted = true;
                        video.loop = true;
                    }
                    video.play().catch(err => {
                        console.warn("æ’­æ”¾è¢«é˜»æ­¢", err);
                    });
                    return;
                }

                // é™çº§ï¼šç›´æ¥è®¾ç½® src
                if (video.src !== targetSrc) {
                    video.src = targetSrc;
                }
                video.muted = true;
                video.loop = true;
                video.play().catch(err => {
                    console.warn("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢", err);
                });
            }



            async function startRecording() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);
                    scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);

                    mediaStreamSource.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    // å»ºç«‹ WebSocket
                    ws = new WebSocket('wss://10.199.164.14:5001/record');

                    ws.onopen = () => {
                        console.log("Record WebSocket å·²è¿æ¥");
                    };

                    ws.onmessage = function (event) {
                        const data = JSON.parse(event.data);

                        //partial
                        if (data.type === 'partial') {
                            partialText = data.text;
                            updateChatMessage(partialText);
                        }


                        if (data.type === 'final') {
                            partialText = "";
                            currentText += data.text;
                            updateChatMessage(currentText);
                        }
                    };

                    ws.onerror = function (err) {
                        console.error("Record WebSocket é”™è¯¯:", err);
                    };

                    ws.onclose = function () {
                        console.log("Record WebSocket å·²å…³é—­");
                    };

                    scriptProcessor.onaudioprocess = function (e) {
                        const inputBuffer = e.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        const buffer = new ArrayBuffer(inputData.length * 2);
                        const view = new DataView(buffer);
                        let index = 0;
                        for (let i = 0; i < inputData.length; i++) {
                            const s = Math.max(-1, Math.min(1, inputData[i]));
                            const val = s < 0 ? s * 0x8000 : s * 0x7FFF;
                            view.setInt16(index, val, true);
                            index += 2;
                        }
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(buffer);
                        }
                    };

                    updateAnimation(ANIMATION_STATE.IDLE);
                } catch (err) {
                    console.error('æ— æ³•è·å–éº¦å…‹é£æƒé™', err);
                    alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
                }
            }

            function stopRecording() {
                console.log(">åœæ­¢å½•éŸ³");
                if (scriptProcessor) {
                    scriptProcessor.disconnect();
                    scriptProcessor.onaudioprocess = null;
                    scriptProcessor = null;
                }
                if (mediaStreamSource) {
                    mediaStreamSource.disconnect();
                    mediaStreamSource = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                if (ws) {
                    ws.close();
                    ws = null;
                }


                if (currentText) {
                    sendMessageToChat(currentText);
                    currentText = "";
                }

                updateAnimation(ANIMATION_STATE.TALKING);
            }

            function updateChatMessage(text) {
                const last = chatBox.lastChild;
                if (last && chatBox.querySelector('.chat-message.user').querySelector('p')) {
                    // last.querySelector('p').textContent = text;

                    chatBox.querySelector('.chat-message.user').querySelector('p').textContent = text;

                    if (chatBox.querySelector('.chat-message.assistant')) {
                        chatBox.querySelector('.chat-message.assistant').querySelector('p').textContent = "";
                    }

                } else {
                    const div = document.createElement('div');
                    div.className = 'chat-message user';
                    div.innerHTML = `<p>${text}</p>`;
                    chatBox.appendChild(div);
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function appendAssistantMessage(text) {
                const div = document.createElement('div');
                div.className = 'chat-message assistant';
                div.innerHTML = `<p>${text}</p>`;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            let currentConversationId = ""; // ä¿å­˜å½“å‰ä¼šè¯ ID
            let currentUser = "user-001";   // å‡è®¾å‰ç«¯æŒ‡å®šç”¨æˆ· ID


            async function sendMessageToChat(text) {
                console.log("å‘é€ç”¨æˆ·è¾“å…¥ï¼š", text);
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text,
                        user_id: currentUser,
                        conversation_id: currentConversationId
                    })
                });

                if (!response.ok) {
                    appendAssistantMessage("æŠ±æ­‰ï¼ŒæœåŠ¡å™¨å‡ºé”™äº†ã€‚");
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    console.log("æ¥æ”¶åˆ°çš„æ•°æ®ï¼š", chunk);

                    // ===== ä¿®å¤å…³é”®ï¼šå¤„ç†åŒ…å«ç»“æŸæ ‡è®°çš„chunk =====
                    const endIndex = chunk.indexOf("ã€å¯¹è¯ç»“æŸã€‘");
                    if (endIndex !== -1) {
                        // 1. æå–ç»“æŸæ ‡è®°å‰çš„æœ‰æ•ˆæ–‡æœ¬
                        const validText = chunk.substring(0, endIndex);
                        assistantText += validText;

                        // 2. ç«‹å³æ›´æ–°UIï¼ˆä¿®å¤ç‚¹ï¼šç¡®ä¿æœ‰æ•ˆæ–‡æœ¬è¢«æ˜¾ç¤ºï¼‰
                        if (chatBox.lastChild && chatBox.lastChild.classList.contains('assistant')) {
                            chatBox.lastChild.querySelector('p').textContent = assistantText;
                        } else if (validText.trim()) { // é¿å…åˆ›å»ºç©ºæ¶ˆæ¯
                            appendAssistantMessage(assistantText);
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;

                        // 3. å¤„ç†ç»“æŸæ ‡è®°ï¼ˆæå–conversation_idï¼‰
                        const match = chunk.match(/Conversation ID: ([a-f0-9\-]+)/);
                        if (match) {
                            currentConversationId = match[1];
                            console.log("æ›´æ–° conversation_id ä¸ºï¼š", currentConversationId);
                        }
                        // æ³¨æ„ï¼šç»“æŸæ ‡è®°åçš„éƒ¨åˆ†ï¼ˆå¦‚IDä¿¡æ¯ï¼‰ä¸æ·»åŠ åˆ°æ¶ˆæ¯
                    }
                    // ===== ä¿®å¤ç»“æŸ =====
                    else {
                        assistantText += chunk;
                        if (chatBox.lastChild && chatBox.lastChild.classList.contains('assistant')) {
                            chatBox.lastChild.querySelector('p').textContent = assistantText;
                        } else {
                            appendAssistantMessage(assistantText);
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }

                if (assistantText.trim()) {
                    playTextToSpeech(assistantText);
                }

                if (assistantText.trim()) {
                    playTextToSpeech(assistantText); // è°ƒç”¨ TTS æ’­æ”¾è¯­éŸ³

                }
            }





            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            recordBtn.addEventListener('mousedown', startRecording);
            recordBtn.addEventListener('mouseup', stopRecording);


            recordBtn.addEventListener('touchstart', e => {
                e.preventDefault();
                startRecording();
            });
            recordBtn.addEventListener('touchend', e => {
                e.preventDefault();
                stopRecording();
            });

            // åˆå§‹åŒ–é¢„åŠ è½½
            async function initAnimationSystem() {
                try {
                    await Promise.all([
                        preloadVideo('idle', videoSources.idle),
                        preloadVideo('talking', videoSources.talking)
                    ]);
                    console.log('âœ… è§†é¢‘é¢„åŠ è½½å®Œæˆ');
                } catch (err) {
                    console.warn('âš ï¸ è§†é¢‘é¢„åŠ è½½å¤±è´¥ï¼Œé™çº§å¤„ç†', err);
                }
            }


            // é¡µé¢åŠ è½½å®Œæˆåé¢„åŠ è½½åŠ¨ç”»è§†é¢‘
            window.addEventListener('load', () => {
                initAnimationSystem();
            });

        </script>



</body>

</html>
